# =============================================================================
# GitHub Actions - Deploy to Production
# Runs on self-hosted runner installed on the production server
# Multi-stage Docker builds (everything built inside Docker)
# Auto-increments patch version on each successful deploy (v0.1.0 -> v0.1.1)
#
# Prerequisites:
#   1. Self-hosted runner installed on your server
#   2. .env.prod file on the server with production secrets
#   3. server-infra network created (via server-infra docker compose)
#   4. Update PROJECT_DIR below to match your server path
# =============================================================================

name: Deploy Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  # TODO: Update this path to match your server setup
  PROJECT_DIR: /home/debian/projects/myproject

defaults:
  run:
    # TODO: Update this path to match your server setup
    working-directory: /home/debian/projects/myproject

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Pull latest code and tags
        run: |
          git fetch origin main --tags
          git reset --hard origin/main

      - name: Build and deploy Docker images
        env:
          DOCKER_BUILDKIT: 1
        run: |
          docker compose -f docker-compose.prod.yml --env-file .env.prod build --parallel api web

          docker compose -f docker-compose.prod.yml --env-file .env.prod up -d

          echo "Waiting for API to be ready..."
          for i in {1..12}; do
            if docker compose -f docker-compose.prod.yml exec -T api \
              wget -qO- http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "API is ready!"
              break
            fi
            if [ "$i" -eq 12 ]; then
              echo "ERROR: API failed to become healthy after 60s"
              docker compose -f docker-compose.prod.yml logs api --tail=50
              exit 1
            fi
            echo "Attempt $i/12 - waiting 5s..."
            sleep 5
          done

      - name: Run database migrations
        run: |
          docker compose -f docker-compose.prod.yml exec -T api \
            npx prisma migrate deploy --schema ./prisma/schema.prisma

      - name: Cleanup and status
        run: |
          docker image prune -f
          docker compose -f docker-compose.prod.yml --env-file .env.prod ps

      - name: Create new version tag
        run: |
          LATEST_TAG=$(git tag -l 'v*' --sort=-version:refname | head -1)
          LATEST_TAG=${LATEST_TAG:-v0.0.0}
          echo "Latest tag: $LATEST_TAG"

          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          NEW_TAG="v${MAJOR}.${MINOR}.$((PATCH + 1))"

          echo "Creating new tag: $NEW_TAG"

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "$NEW_TAG" -m "Auto-release after deploy to production"
          git push origin "$NEW_TAG" || echo "Warning: Could not push tag (deploy key may be read-only)"

          echo "Tag: $NEW_TAG"
