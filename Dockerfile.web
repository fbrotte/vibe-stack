# =============================================================================
# Dockerfile.web - Multi-stage build for React/Vite frontend
# =============================================================================

# ---------------------------------------------------------------------------
# Stage 1: Build static files
# ---------------------------------------------------------------------------
FROM oven/bun:1-alpine AS build

WORKDIR /app

# VITE_* vars must be available at build time (baked into the bundle)
ARG VITE_API_URL
ARG VITE_TRPC_URL

# Copy workspace structure for lockfile validation
COPY package.json bun.lock ./
COPY apps/api/package.json ./apps/api/
COPY apps/web/package.json ./apps/web/
COPY packages/shared/package.json ./packages/shared/

# Install all dependencies
RUN --mount=type=cache,target=/root/.bun/install/cache \
    bun install --frozen-lockfile

# Copy source code needed for build
COPY packages/shared/ ./packages/shared/
COPY apps/web/ ./apps/web/

# Set env vars for Vite build
ENV VITE_API_URL=${VITE_API_URL}
ENV VITE_TRPC_URL=${VITE_TRPC_URL}

# Skip tsc type-check in Docker (handled in CI), only run vite build
RUN cd apps/web && bunx vite build

# ---------------------------------------------------------------------------
# Stage 2: Serve with nginx
# ---------------------------------------------------------------------------
FROM nginx:alpine AS runtime

# Copy built static files
COPY --from=build /app/apps/web/dist/ /usr/share/nginx/html/

# Copy nginx configuration
COPY infrastructure/nginx/nginx.conf /etc/nginx/nginx.conf

# Setup non-root user
RUN chown -R nginx:nginx /usr/share/nginx/html && \
    chown -R nginx:nginx /var/cache/nginx && \
    chown -R nginx:nginx /var/log/nginx && \
    touch /var/run/nginx.pid && \
    chown -R nginx:nginx /var/run/nginx.pid

USER nginx

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
